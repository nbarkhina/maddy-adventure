let debugStats = ""
let coin: Sprite = null
let playerStartLocation: tiles.Location = null
let flier: Sprite = null
let bumper: Sprite = null
let flierIdle: animation.Animation = null
let heroFacingLeft = false
let fire: Sprite = null
let heroRight: animation.Animation = null
let heroLeft: animation.Animation = null
let hasFire = false
let doubleJumpSpeed = 0
let canDoubleJump = false
let coinAnimation: animation.Animation = null
let currentLevel = 0
let levelCount = 0
let gravity = 0
let pixelsToMeters = 0
let invincibilityPeriod = 0
let hero: Sprite = null
let flierFlying = null
let mainRunLeft = null
let mainRunRight = null
let mainJumpLeft = null
let mainJumpRight = null
let mainCrouchLeft = null
let mainCrouchRight = null

enum ActionKind {
    RunningLeft,
    RunningRight,
    Idle,
    IdleLeft,
    IdleRight,
    JumpingLeft,
    JumpingRight,
    CrouchLeft,
    CrouchRight,
    Flying,
    Walking,
    Jumping
}

namespace SpriteKind {
    export const Bumper = SpriteKind.create()
    export const Goal = SpriteKind.create()
    export const Coin = SpriteKind.create()
    export const Flier = SpriteKind.create()
    export const Fire = SpriteKind.create()
    export const Lava = SpriteKind.create();
}

function main()
{
    //title screen
    showStartingInstructions();

    //initialize app
    init();

    //run first level
    setLevelTileMap(currentLevel)
}


function init()
{
    //the order of these things matters - careful when rearranging these

    // how long to pause between each contact with a single enemy
    invincibilityPeriod = 600
    pixelsToMeters = 30
    gravity = 9.81 * pixelsToMeters

    processCollisions();
    gameUpdate();
    controllerInput();

    //create player
    hero = sprites.create(img`
        3 .
        . .
    `, SpriteKind.Player)
    createPlayer(hero)

    //set background image/color
    scene.setBackgroundImage(img`
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888ddddddddddd8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        88888888888888888888888888858ddddddddddddddd88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888888888dddddddddddddddd5dd888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888
        88888888888888888888888888ddddddddddddddddddddd88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888ddddddddddddddddddddddd8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888888dd5dddddddd5ddddddddddddd888888888888888888888888888888888888888888888888888888888858888888888888888888888858888888888888888888888888888
        88888888888888888888888ddddddddddddddddddddddddddd88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        88888888888888588888888dddd5dddddddddddddddddddddd88888888888888888888888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888
        8888888888888888888888ddddddddddddddddddddddddddddd8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888ddddddddddddddddddddddddddddd8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888dd5dddddddddddddddddddddddddd5d888588888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888ddddddddddddddddddddddddddddddd888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888885888888ddddddddddddddddddddddddddddddd888888888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888
        888888888888888888888dd5dddddddddddddddddddddddddddd888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888ddddddddddddddddddddddddddddddd888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888ddddddddddddddddddddddddddddddd888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888ddddddddddddddddddddddddddddddd888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888ddddddddddddddddddddddddddddddd888888888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888dddd5dddddddddddddddddddddddddd888888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888ddddddddddddddddddddddddddddddd888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888ddddddddddddddddddddddddddddddd888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888ddddddddddddddddddddddddddddd8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888ddddddddddddddddddddddddddddd8888888888888888888888888888888888888888888888888888888888888888888888888888888888588888888888888888888888888
        88888888888888888888888ddddddddddddddddddddddddddd88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        88888888888888888888888ddddddddddddddddddddddddddd88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888588ddddddddddddddddddddddddd888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888ddddddddddddddddddddddd8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        88888888888888888888888888ddddddddddddddddddddd88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        888888888888888888888888888ddddddddddddddddddd888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        88888888888888888888888888888ddddddddddddddd88888888888888888888888888888888888888888888888888888888888888858888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888ddddddddddd8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888885888858888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888885888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888585888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888885888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888885888888588888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888858888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888588888888888888888888888858888888888888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888588888888888888888888888888888888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888858888888888888888888888888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888588888888888888888888888
        8888888888888888888888888858888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888885888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888588888888885888888888888888888888888888888888888888888858888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888858888888888888888888888888888888888858888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888858888888888888888888888888588888888888888888888888888888888
        8888888888888888888888888888885888888888885888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888555888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888858888888888888858888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888588888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888858888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
        8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    `)

    initializeAnimations()

    levelCount = 8
    currentLevel = 0
}

function showStartingInstructions()
{
    //dialog frame and icon
    game.setDialogFrame(img`
        . 2 2 2 2 2 2 2 2 2 2 2 2 2 . . 
        2 2 1 1 1 1 1 1 1 1 1 1 1 2 2 . 
        2 1 1 2 2 2 2 2 2 2 2 2 1 1 2 . 
        2 1 2 2 1 1 1 1 1 1 1 2 2 1 2 . 
        2 1 2 1 1 1 1 1 1 1 1 1 2 1 2 . 
        2 1 2 1 1 1 1 1 1 1 1 1 2 1 2 . 
        2 1 2 1 1 1 1 1 1 1 1 1 2 1 2 . 
        2 1 2 1 1 1 1 1 1 1 1 1 2 1 2 . 
        2 1 2 1 1 1 1 1 1 1 1 1 2 1 2 . 
        2 1 2 1 1 1 1 1 1 1 1 1 2 1 2 . 
        2 1 2 1 1 1 1 1 1 1 1 1 2 1 2 . 
        2 1 2 2 1 1 1 1 1 1 1 2 2 1 2 . 
        2 1 1 2 2 2 2 2 2 2 2 2 1 1 2 . 
        2 2 1 1 1 1 1 1 1 1 1 1 1 2 2 . 
        . 2 2 2 2 2 2 2 2 2 2 2 2 2 . . 
        . . . . . . . . . . . . . . . . 
        `)
    game.setDialogCursor(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . f f f f . . . . . . 
        . . . . f f 5 5 5 5 f f . . . . 
        . . . . f 5 5 5 5 5 5 f . . . . 
        . . . f 5 5 5 4 4 5 5 5 f . . . 
        . . . f 5 5 5 4 4 5 5 5 f . . . 
        . . . f 5 5 5 4 4 5 5 5 f . . . 
        . . . f 5 5 5 4 4 5 5 5 f . . . 
        . . . . f 5 5 5 5 5 5 f . . . . 
        . . . . f f 5 5 5 5 f f . . . . 
        . . . . . . f f f f . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `)
        
    //show beginning instructions
    // showInstruction("Welcome to Madelyn's Adventure.")
    // showInstruction("Greenstone goes around and tries to get all the bad guys.")
    // showInstruction("He has to shoot the bad guys with his fire Power.")
}

function showInstruction(text: string) {
    game.showLongText(text, DialogLayout.Bottom)
    music.baDing.play()
    info.changeScoreBy(1)
}

let lavaCounter = 0;
let volcanoCounter = 0;

function gameUpdate()
{
    // set up hero animations
    game.onUpdate(function () {

        lavaCounter++;
        if (lavaCounter == 50)
        {
            lavaCounter = 0;
            spawnLava();
        }

        volcanoCounter++;
        if (volcanoCounter == 10) {
            volcanoCounter = 0;
            animateVolcano();
        }

        // if (hero.vx < 0) {
        //     heroFacingLeft = true
        //     animation.setAction(hero, ActionKind.IdleLeft)
        // } else if (hero.vx > 0) {
        //     animation.setAction(hero, ActionKind.IdleRight)
        //     heroFacingLeft = false
        // }
        if (hero.isHittingTile(CollisionDirection.Top)) {
            hero.vy = 0
        }
        // game.consoleOverlay.setVisible(true);
        // screen.printCenter("X: " + hero.tilemapLocation().x + " Y: " + hero.tilemapLocation().y,
        // 50);
        // console.log("X: " + hero.x + " Y: " + hero.y);
        debugStats = "X: " + Math.floor(hero.x) + " Y: " + Math.floor(hero.y)
        //hero.sayText(debugStats, 100)
    })

    // Flier movement
    game.onUpdate(function () {
        for (let value8 of sprites.allOfKind(SpriteKind.Flier)) {
            if (Math.abs(value8.x - hero.x) < 60) {
                if (value8.x - hero.x < -5) {
                    value8.vx = 25
                } else if (value8.x - hero.x > 5) {
                    value8.vx = -25
                }
                if (value8.y - hero.y < -5) {
                    value8.vy = 25
                } else if (value8.y - hero.y > 5) {
                    value8.vy = -25
                }
                animation.setAction(value8, ActionKind.Idle)
            } else {
                value8.vy = -20
                value8.vx = 0
                animation.setAction(value8, ActionKind.Idle)
            }
        }
    })

    // Reset double jump when standing on wall
    game.onUpdate(function () {
        if (hero.isHittingTile(CollisionDirection.Bottom)) {
            canDoubleJump = true
        }
    })

    // bumper movement
    game.onUpdate(function () {
        for (let value9 of sprites.allOfKind(SpriteKind.Bumper)) {
            if (value9.isHittingTile(CollisionDirection.Left)) {
                value9.vx = Math.randomRange(30, 60)
            } else if (value9.isHittingTile(CollisionDirection.Right)) {
                value9.vx = Math.randomRange(-60, -30)
            }
        }
    })


}

function processCollisions()
{

    //player collects coins
    sprites.onOverlap(SpriteKind.Player, SpriteKind.Coin, function (sprite, otherSprite) {
        otherSprite.destroy(effects.trail, 250)
        otherSprite.y += -3
        info.changeScoreBy(3)
        music.baDing.play()
    })


    //player vs enemies
    sprites.onOverlap(SpriteKind.Player, SpriteKind.Bumper, function (sprite, otherSprite) {
        if (sprite.vy > 0 && !(sprite.isHittingTile(CollisionDirection.Bottom)) || sprite.y < otherSprite.top) {
            otherSprite.destroy(effects.ashes, 250)
            otherSprite.vy = -50
            sprite.vy = -2 * pixelsToMeters
            info.changeScoreBy(1)
            music.powerUp.play()
        } else {
            info.changeLifeBy(-1)
            sprite.say("Ow!", invincibilityPeriod)
            music.powerDown.play()
        }
        pause(invincibilityPeriod)
    })
    sprites.onOverlap(SpriteKind.Player, SpriteKind.Flier, function (sprite, otherSprite) {
        info.changeLifeBy(-1)
        sprite.say("Ow!", invincibilityPeriod * 1.5)
        music.powerDown.play()
        pause(invincibilityPeriod * 1.5)
    })

    //when fire hits wall
    scene.onHitWall(SpriteKind.Fire, function (sprite, location) {
        sprite.destroy()
    })

    //lava
    scene.onHitWall(SpriteKind.Lava, function (sprite, location) {
        sprite.destroy()
    })
    sprites.onOverlap(SpriteKind.Player, SpriteKind.Lava, function (sprite, otherSprite) {
        otherSprite.destroy(effects.trail, 250)
        info.changeLifeBy(-1)
        sprite.say("Ow!", invincibilityPeriod)
        music.powerDown.play()
    })

    //player touches flag
    scene.onOverlapTile(SpriteKind.Player, assets.tile`tile1`, function (sprite, location) {
        info.changeLifeBy(1)
        currentLevel += 1
        if (hasNextLevel()) {
            game.splash("Next level unlocked!")
            setLevelTileMap(currentLevel)
        } else {
            game.over(true, effects.confetti)
        }
    })

    //fire vs enemies
    sprites.onOverlap(SpriteKind.Fire, SpriteKind.Bumper, function (sprite, otherSprite) {
        sprite.destroy()
        otherSprite.destroy()
    })
    sprites.onOverlap(SpriteKind.Fire, SpriteKind.Flier, function (sprite, otherSprite) {
        sprite.destroy()
        otherSprite.destroy()
    })

    //flower power
    scene.onOverlapTile(SpriteKind.Player, assets.tile`myFlower`, function (sprite, location) {
        // clear flower tile
        tiles.setTileAt(location, assets.tile`tile0`)
        music.powerUp.play()
        hasFire = true
    })
}

function initializeAnimations()
{
    
    //coin animations
    coinAnimation = animation.createAnimation(ActionKind.Idle, 200)
    coinAnimation.addAnimationFrame(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . f f f f . . . . . . 
        . . . . f f 5 5 5 5 f f . . . . 
        . . . . f 5 5 5 5 5 5 f . . . . 
        . . . f 5 5 5 4 4 5 5 5 f . . . 
        . . . f 5 5 5 4 4 5 5 5 f . . . 
        . . . f 5 5 5 4 4 5 5 5 f . . . 
        . . . f 5 5 5 4 4 5 5 5 f . . . 
        . . . . f 5 5 5 5 5 5 f . . . . 
        . . . . f f 5 5 5 5 f f . . . . 
        . . . . . . f f f f . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `)
    coinAnimation.addAnimationFrame(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . f f f f f f . . . . . . 
        . . . f f 5 f 5 5 5 f . . . . . 
        . . . f 5 f 5 5 5 5 5 f . . . . 
        . . f 5 f 5 5 5 4 5 5 f . . . . 
        . . f 5 f 5 5 5 4 4 5 5 f . . . 
        . . f 5 f 5 5 5 4 4 5 5 f . . . 
        . . f 5 f 5 5 5 4 5 5 f . . . . 
        . . . f 5 f 5 5 5 5 5 f . . . . 
        . . . . f 5 f 5 5 5 f . . . . . 
        . . . . f f f f f f . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `)
    coinAnimation.addAnimationFrame(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . f f f f f . . . . . . 
        . . . . f f 5 f 5 f f . . . . . 
        . . . f f 5 f 5 5 5 f . . . . . 
        . . . f 5 f 5 5 5 5 f f . . . . 
        . . . f 5 f 5 5 4 5 5 f . . . . 
        . . . f 5 f 5 5 4 5 5 f . . . . 
        . . . f 5 f 5 5 5 5 f f . . . . 
        . . . f f 5 f 5 5 5 f . . . . . 
        . . . . f f 5 f 5 f f . . . . . 
        . . . . . f f f f f . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `)
    coinAnimation.addAnimationFrame(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . f f f f . . . . . . 
        . . . . . f f f f f . . . . . . 
        . . . . . f 5 f 5 f f . . . . . 
        . . . . . f 5 f 5 5 f . . . . . 
        . . . . . f 5 f 5 5 f . . . . . 
        . . . . . f 5 f 5 5 f . . . . . 
        . . . . . f 5 f 5 5 f . . . . . 
        . . . . . f 5 f 5 f f . . . . . 
        . . . . . f f f f f . . . . . . 
        . . . . . . f f f f . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `)
    coinAnimation.addAnimationFrame(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . f f f f . . . . . . 
        . . . . . . f f f f f . . . . . 
        . . . . . f f 5 f 5 f . . . . . 
        . . . . . f 5 5 f 5 f . . . . . 
        . . . . . f 5 5 f 5 f . . . . . 
        . . . . . f 5 5 f 5 f . . . . . 
        . . . . . f 5 5 f 5 f . . . . . 
        . . . . . f f 5 f 5 f . . . . . 
        . . . . . . f f f f f . . . . . 
        . . . . . . f f f f . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `)
    coinAnimation.addAnimationFrame(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . f f f f f . . . . . 
        . . . . . f f 5 f 5 f f . . . . 
        . . . . . f 5 5 5 f 5 f f . . . 
        . . . . f f 5 5 5 5 f 5 f . . . 
        . . . . f 5 5 4 5 5 f 5 f . . . 
        . . . . f 5 5 4 5 5 f 5 f . . . 
        . . . . f f 5 5 5 5 f 5 f . . . 
        . . . . . f 5 5 5 f 5 f f . . . 
        . . . . . f f 5 f 5 f f . . . . 
        . . . . . . f f f f f . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `)
    coinAnimation.addAnimationFrame(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . f f f f f f . . . . 
        . . . . . f 5 5 5 f 5 f f . . . 
        . . . . f 5 5 5 5 5 f 5 f . . . 
        . . . . f 5 5 4 5 5 5 f 5 f . . 
        . . . f 5 5 4 4 5 5 5 f 5 f . . 
        . . . f 5 5 4 4 5 5 5 f 5 f . . 
        . . . . f 5 5 4 5 5 5 f 5 f . . 
        . . . . f 5 5 5 5 5 f 5 f . . . 
        . . . . . f 5 5 5 f 5 f . . . . 
        . . . . . . f f f f f f . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `)
    
    //initializeFlierAnimations
    flierIdle = animation.createAnimation(ActionKind.Idle, 100)
    flierIdle.addAnimationFrame(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . e e e e . . . . . . . 
        . . . . . e e e e . . . . . . . 
        . . . . . e e e e . . . . . . . 
        . . . . . e e e e . . . . . . . 
        . . . . . e e e e . . . . . . . 
        8 8 8 8 8 8 8 8 8 8 8 . . . . . 
        8 8 8 8 8 8 8 8 8 8 8 . . . . . 
        8 8 8 8 8 8 8 8 8 8 8 . . . . . 
        8 8 8 f 8 8 8 8 f 8 8 . . . . . 
        8 8 8 8 8 8 8 8 8 8 8 . . . . . 
        8 8 8 8 8 8 8 8 8 8 8 e e e e . 
        8 8 8 f f f f f 8 8 8 e e e e . 
        8 8 8 f 8 8 8 f 8 8 8 . . . . . 
        8 8 8 f 8 8 8 f 8 8 8 . . . . . 
        `)

    heroLeft = animation.createAnimation(ActionKind.IdleLeft, 200)
    heroLeft.addAnimationFrame(img`
        ........................
        ........................
        .................ff.....
        ....ff...6666....ff.....
        ....ff.6666666666ff.....
        ....ff666666666666......
        .....66655565556666.....
        .....6665f565f56666.....
        .....66655565556666.....
        .....666666f6666666.....
        .....666666f666666......
        ......6666666666........
        ........66666666........
        ..666..666ff6666........
        ..666666666666666666....
        ..666fff666666ff6666....
        ...6666666666ff66666....
        .......66ff6666666......
        ........666666666.......
        ........666666f666......
        ........6666fff666......
        ......fff666666fff......
        ......fff666666fff......
        ......fff......fff......
    `)
    heroLeft.addAnimationFrame(img`
        ........................
        ........................
        .................ff.....
        ....ff...6666....ff.....
        ....ff.6666666666ff.....
        ....ff666666666666......
        .....66655565556666.....
        .....6665f565f56666.....
        .....66655565556666.....
        .....666666f6666666.....
        .....666666f666666......
        ......6666666666........
        ........66666666........
        .......666ff6666........
        .......6666666666.......
        ......ff666666ff6666....
        ....666666666ff666666...
        ...666666ff66666666666..
        ...6666.666666666..666..
        ...666..666666f666......
        ........6666fff666......
        ......fff666666fff......
        ......fff666666fff......
        ......fff......fff......
    `)
    animation.attachAnimation(hero, heroLeft)



}

function controllerInput()
{

    controller.B.onEvent(ControllerButtonEvent.Pressed, function () {
        if (hasFire) {
            spawnFire()
        }
    })
    // controller.down.onEvent(ControllerButtonEvent.Pressed, function () {
    //     if (!(hero.isHittingTile(CollisionDirection.Bottom))) {
    //         hero.vy += 80
    //     }
    // })
    controller.A.onEvent(ControllerButtonEvent.Pressed, function () {
        attemptJump()
    })
}

function attemptJump () {
    // else if: either fell off a ledge, or double jumping
    if (hero.isHittingTile(CollisionDirection.Bottom)) {
        hero.vy = -4 * pixelsToMeters
    } else {
        doubleJumpSpeed = -3 * pixelsToMeters
        // Good double jump
        // if (hero.vy >= -40) {
        //     doubleJumpSpeed = -4.5 * pixelsToMeters
        //     hero.startEffect(effects.trail, 500)
        //     scene.cameraShake(2, 250)
        // }
        hero.vy = doubleJumpSpeed
        //canDoubleJump = false
    }
}

//fire effect from volcano
function animateVolcano(){
    for (let i of tiles.getTilesByType(assets.tile`volcanoTile`)) {
        let lavaRight = sprites.create(img`
            . . . . . . . . . 2 . . . . . .
            . . . . . . . . . 2 . . . 4 . .
            2 . . . . 4 . . 2 2 . . 4 . . .
            . 2 . . . 4 b b b b b b 4 . . .
            . . 2 b b b b b b b b b b 2 2 .
            . b b b b b b b b b b b 2 2 2 2
            . b b b b b b b b b b b b b . .
            . b b b b b b b b b b b b b . .
            4 4 b b b b b b b b b b b 4 4 .
            . b b b b b b b b b b 2 2 b . .
            . . b b 4 b b b 4 b b . 2 . . .
            2 2 2 . 4 . 2 . 4 . . . 2 . . .
            2 . . . . 2 . . . . . . 2 2 . .
            . . . . . 2 . . . . . . . 2 . .
            . . . . . 2 . . . . . . . . . .
            . . . . . . . . . . . . . . . .
        `, SpriteKind.Lava)
        tiles.placeOnTile(lavaRight, i);
        lavaRight.startEffect(effects.fire);
        lavaRight.vx = 5;
        lavaRight.vy = 5;
    }
}

//lava particles from volcano
function spawnLava(){
    for (let i of tiles.getTilesByType(assets.tile`volcanoTile`)) {
        let lavaRight = sprites.create(img`
            . . . . . . . . . 2 . . . . . .
            . . . . . . . . . 2 . . . 4 . .
            2 . . . . 4 . . 2 2 . . 4 . . .
            . 2 . . . 4 b b b b b b 4 . . .
            . . 2 b b b b b b b b b b 2 2 .
            . b b b b b b b b b b b 2 2 2 2
            . b b b b b b b b b b b b b . .
            . b b b b b b b b b b b b b . .
            4 4 b b b b b b b b b b b 4 4 .
            . b b b b b b b b b b 2 2 b . .
            . . b b 4 b b b 4 b b . 2 . . .
            2 2 2 . 4 . 2 . 4 . . . 2 . . .
            2 . . . . 2 . . . . . . 2 2 . .
            . . . . . 2 . . . . . . . 2 . .
            . . . . . 2 . . . . . . . . . .
            . . . . . . . . . . . . . . . .
        `, SpriteKind.Lava)
        tiles.placeOnTile(lavaRight, i);
        lavaRight.startEffect(effects.fire);
        lavaRight.vx = 90;
        lavaRight.vy = -70;
        lavaRight.ay = gravity;

        let lavaLeft = sprites.create(img`
            . . . . . . . . . 2 . . . . . .
            . . . . . . . . . 2 . . . 4 . .
            2 . . . . 4 . . 2 2 . . 4 . . .
            . 2 . . . 4 b b b b b b 4 . . .
            . . 2 b b b b b b b b b b 2 2 .
            . b b b b b b b b b b b 2 2 2 2
            . b b b b b b b b b b b b b . .
            . b b b b b b b b b b b b b . .
            4 4 b b b b b b b b b b b 4 4 .
            . b b b b b b b b b b 2 2 b . .
            . . b b 4 b b b 4 b b . 2 . . .
            2 2 2 . 4 . 2 . 4 . . . 2 . . .
            2 . . . . 2 . . . . . . 2 2 . .
            . . . . . 2 . . . . . . . 2 . .
            . . . . . 2 . . . . . . . . . .
            . . . . . . . . . . . . . . . .
        `, SpriteKind.Lava)
        tiles.placeOnTile(lavaLeft, i);
        lavaLeft.startEffect(effects.fire);
        lavaLeft.vx = -90;
        lavaLeft.vy = -70;
        lavaLeft.ay = gravity;
    }
}

function spawnFire () {
    fire = sprites.create(img`
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        2 2 2 2 2 2 2 . . . . . . . . . 
        2 2 2 2 2 2 2 . . . . . . . . . 
        2 2 2 2 2 2 2 . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        . . . . . . . . . . . . . . . . 
        `, SpriteKind.Fire)
    fire.setPosition(hero.x, hero.y)
    if (heroFacingLeft) {
        fire.setVelocity(-160, 0)
    } else {
        fire.setVelocity(160, 0)
    }
    fire.startEffect(effects.fire);
}

function setLevelTileMap (level: number) {
    clearGame()

    if (level == 0) {
        tiles.setTilemap(tilemap`levelMaddy`)
    } else if (level == 1) {
        tiles.setTilemap(tilemap`maddyLevel2`)
    } else if (level == 2) {
        tiles.setTilemap(tilemap`level_1`)
    } else if (level == 3) {
        tiles.setTilemap(tilemap`level_2`)
    } else if (level == 4) {
        tiles.setTilemap(tilemap`level_3`)
    } else if (level == 5) {
        tiles.setTilemap(tilemap`level_4`)
    } else if (level == 6) {
        tiles.setTilemap(tilemap`level_5`)
    } else if (level == 7) {
        tiles.setTilemap(tilemap`level_6`)
    }

    initializeLevel(level)
}

function clearGame () {
    for (let value of sprites.allOfKind(SpriteKind.Bumper)) {
        value.destroy()
    }
    for (let value2 of sprites.allOfKind(SpriteKind.Coin)) {
        value2.destroy()
    }
    for (let value3 of sprites.allOfKind(SpriteKind.Goal)) {
        value3.destroy()
    }
    for (let value4 of sprites.allOfKind(SpriteKind.Flier)) {
        value4.destroy()
    }
    for (let value5 of sprites.allOfKind(SpriteKind.Fire)) {
        value5.destroy()
    }
}

function createEnemies () {
    // enemy that moves back and forth
    for (let value52 of tiles.getTilesByType(assets.tile`tile4`)) {
        bumper = sprites.create(img`
            . . . . . . . . . . . . . . . .
            . . . . . . . . . . . . . . . .
            f f f f f . . . . . . . f f f f
            f 3 3 3 f . . . . . . . f 3 3 f
            f f 3 3 f f f f f f f f f 3 f f
            . f f f f 7 7 7 7 7 f f 3 3 f .
            . . . . f 7 f 7 7 f 7 f f f f .
            f f f f f 7 7 7 7 7 7 7 f . . .
            f 3 3 3 f 7 7 7 7 7 7 7 f f f .
            f f f f f 7 f f f 7 7 7 f 3 f f
            . . . . f 7 7 7 7 7 7 7 f 3 f f
            . . . f f f f 7 7 7 7 f f f f .
            f f f 3 3 3 f f f f f f f f f .
            f f 3 3 3 f f . . f f 3 3 3 f f
            . f f f f f . . . . f f 3 3 3 f
            . . . . . . . . . . . . f f f f
        `, SpriteKind.Bumper)
        tiles.placeOnTile(bumper, value52)
        tiles.setTileAt(value52, assets.tile`tile0`)
        bumper.ay = gravity
        if (Math.percentChance(50)) {
            bumper.vx = Math.randomRange(30, 60)
        } else {
            bumper.vx = Math.randomRange(-60, -30)
        }
    }
    // enemy that flies at player
    for (let value6 of tiles.getTilesByType(assets.tile`tile7`)) {
        flier = sprites.create(img`
            . . . . . . . . . . . . . . . . 
            . . . . . . . . . . . . . . . . 
            . . . . . e e e e . . . . . . . 
            . . . . . e e e e . . . . . . . 
            . . . . . e e e e . . . . . . . 
            . . . . . e e e e . . . . . . . 
            . . . . . e e e e . . . . . . . 
            8 8 8 8 8 8 8 8 8 8 8 . . . . . 
            8 8 8 8 8 8 8 8 8 8 8 . . . . . 
            8 8 8 8 8 8 8 8 8 8 8 . . . . . 
            8 8 8 f 8 8 8 8 f 8 8 . . . . . 
            8 8 8 8 8 8 8 8 8 8 8 . . . . . 
            8 8 8 8 8 8 8 8 8 8 8 e e e e . 
            8 8 8 f f f f f 8 8 8 e e e e . 
            8 8 8 f 8 8 8 f 8 8 8 . . . . . 
            8 8 8 f 8 8 8 f 8 8 8 . . . . . 
            `, SpriteKind.Flier)
        tiles.placeOnTile(flier, value6)
        tiles.setTileAt(value6, assets.tile`tile0`)
        // animation.attachAnimation(flier, flierFlying)
        animation.attachAnimation(flier, flierIdle)
    }
}

function createPlayer (player2: Sprite) {
    player2.ay = gravity
    scene.cameraFollowSprite(player2)
    controller.moveSprite(player2, 100, 0)
    player2.z = 5
    info.setLife(3)
    info.setScore(0)
    animation.setAction(hero, ActionKind.IdleLeft)
}

function initializeLevel (level: number) {
    // effects.clouds.startScreenEffect()
    playerStartLocation = tiles.getTilesByType(assets.tile`tile6`)[0]
    tiles.placeOnTile(hero, playerStartLocation)
    hero.y -= 20
    tiles.setTileAt(playerStartLocation, assets.tile`tile0`)
    createEnemies()
    spawnCoins()
}

function hasNextLevel () {
    return currentLevel != levelCount
}

function spawnCoins () {
    for (let value7 of tiles.getTilesByType(assets.tile`tile5`)) {
        coin = sprites.create(img`
            . . . . . . . . . . . . . . . .
            . . . . . . . . . . . . . . . .
            . . . . . . . . . . . . . . . .
            . . . . . . f f f f . . . . . .
            . . . . f f 5 5 5 5 f f . . . .
            . . . . f 5 5 5 5 5 5 f . . . .
            . . . f 5 5 5 4 4 5 5 5 f . . .
            . . . f 5 5 5 4 4 5 5 5 f . . .
            . . . f 5 5 5 4 4 5 5 5 f . . .
            . . . f 5 5 5 4 4 5 5 5 f . . .
            . . . . f 5 5 5 5 5 5 f . . . .
            . . . . f f 5 5 5 5 f f . . . .
            . . . . . . f f f f . . . . . .
            . . . . . . . . . . . . . . . .
            . . . . . . . . . . . . . . . .
            . . . . . . . . . . . . . . . .
        `, SpriteKind.Coin)
        tiles.placeOnTile(coin, value7)
        animation.attachAnimation(coin, coinAnimation)
        animation.setAction(coin, ActionKind.Idle)
        tiles.setTileAt(value7, assets.tile`tile0`)
    }
}

//run app
main();